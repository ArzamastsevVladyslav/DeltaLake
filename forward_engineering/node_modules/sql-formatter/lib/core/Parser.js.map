{"version":3,"file":"Parser.js","names":["Parser","tokens","statements","stat","statement","push","children","look","value","next","type","NodeType","hasSemicolon","TokenType","EOF","length","undefined","expression","limitClause","clause","binaryClause","functionCall","arraySubscript","parenthesis","betweenPredicate","allColumnsAsterisk","nextTokenNode","RESERVED_COMMAND","name","RESERVED_BINARY_COMMAND","CLOSE_PAREN","nameToken","binary_clause","RESERVED_KEYWORD","IDENT","whitespaceBefore","function_call","array_subscript","arrayToken","OPEN_PAREN","token","openParen","closeParen","isToken","BETWEEN","AND","between_predicate","betweenToken","expr1","andToken","expr2","LIMIT","limit_clause","limitToken","offsetToken","countToken","SELECT","all_columns_asterisk","ahead","index","EOF_TOKEN"],"sources":["../../src/core/Parser.ts"],"sourcesContent":["/* eslint-disable no-cond-assign */\nimport {\n  AllColumnsAsterisk,\n  ArraySubscript,\n  AstNode,\n  BetweenPredicate,\n  BinaryClause,\n  Clause,\n  FunctionCall,\n  LimitClause,\n  NodeType,\n  Parenthesis,\n  Statement,\n  TokenNode,\n} from './ast';\nimport { EOF_TOKEN, type Token, TokenType, isToken } from './token';\n\n/**\n * A simple parser that creates a very rudimentary syntax tree.\n */\nexport default class Parser {\n  private index = 0;\n\n  constructor(private tokens: Token[]) {}\n\n  public parse(): Statement[] {\n    const statements: Statement[] = [];\n    let stat: Statement | undefined;\n    while ((stat = this.statement())) {\n      statements.push(stat);\n    }\n    return statements;\n  }\n\n  private statement(): Statement | undefined {\n    const children: AstNode[] = [];\n    while (true) {\n      if (this.look().value === ';') {\n        this.next();\n        return { type: NodeType.statement, children, hasSemicolon: true };\n      } else if (this.look().type === TokenType.EOF) {\n        if (children.length > 0) {\n          return { type: NodeType.statement, children, hasSemicolon: false };\n        } else {\n          return undefined;\n        }\n      } else {\n        children.push(this.expression());\n      }\n    }\n  }\n\n  private expression(): AstNode {\n    return (\n      this.limitClause() ||\n      this.clause() ||\n      this.binaryClause() ||\n      this.functionCall() ||\n      this.arraySubscript() ||\n      this.parenthesis() ||\n      this.betweenPredicate() ||\n      this.allColumnsAsterisk() ||\n      this.nextTokenNode()\n    );\n  }\n\n  private clause(): Clause | undefined {\n    if (this.look().type === TokenType.RESERVED_COMMAND) {\n      const name = this.next();\n      const children: AstNode[] = [];\n      while (\n        this.look().type !== TokenType.RESERVED_COMMAND &&\n        this.look().type !== TokenType.RESERVED_BINARY_COMMAND &&\n        this.look().type !== TokenType.EOF &&\n        this.look().type !== TokenType.CLOSE_PAREN &&\n        this.look().value !== ';'\n      ) {\n        children.push(this.expression());\n      }\n      return { type: NodeType.clause, nameToken: name, children };\n    }\n    return undefined;\n  }\n\n  private binaryClause(): BinaryClause | undefined {\n    if (this.look().type === TokenType.RESERVED_BINARY_COMMAND) {\n      const name = this.next();\n      const children: AstNode[] = [];\n      while (\n        this.look().type !== TokenType.RESERVED_COMMAND &&\n        this.look().type !== TokenType.RESERVED_BINARY_COMMAND &&\n        this.look().type !== TokenType.EOF &&\n        this.look().type !== TokenType.CLOSE_PAREN &&\n        this.look().value !== ';'\n      ) {\n        children.push(this.expression());\n      }\n      return { type: NodeType.binary_clause, nameToken: name, children };\n    }\n    return undefined;\n  }\n\n  private functionCall(): FunctionCall | undefined {\n    if (\n      (this.look().type === TokenType.RESERVED_KEYWORD || this.look().type === TokenType.IDENT) &&\n      this.look(1).value === '(' &&\n      !this.look(1).whitespaceBefore\n    ) {\n      return {\n        type: NodeType.function_call,\n        nameToken: this.next(),\n        parenthesis: this.parenthesis() as Parenthesis,\n      };\n    }\n    return undefined;\n  }\n\n  private arraySubscript(): ArraySubscript | undefined {\n    if (\n      (this.look().type === TokenType.RESERVED_KEYWORD || this.look().type === TokenType.IDENT) &&\n      this.look(1).value === '['\n    ) {\n      return {\n        type: NodeType.array_subscript,\n        arrayToken: this.next(),\n        parenthesis: this.parenthesis() as Parenthesis,\n      };\n    }\n    return undefined;\n  }\n\n  private parenthesis(): Parenthesis | undefined {\n    if (this.look().type === TokenType.OPEN_PAREN) {\n      const children: AstNode[] = [];\n      const token = this.next();\n      const openParen = token.value;\n      let closeParen = '';\n      while (this.look().type !== TokenType.CLOSE_PAREN && this.look().type !== TokenType.EOF) {\n        children.push(this.expression());\n      }\n      if (this.look().type === TokenType.CLOSE_PAREN) {\n        closeParen = this.next().value;\n      }\n      return { type: NodeType.parenthesis, children, openParen, closeParen };\n    }\n    return undefined;\n  }\n\n  private betweenPredicate(): BetweenPredicate | undefined {\n    if (isToken.BETWEEN(this.look()) && isToken.AND(this.look(2))) {\n      return {\n        type: NodeType.between_predicate,\n        betweenToken: this.next(),\n        expr1: this.next(),\n        andToken: this.next(),\n        expr2: this.next(),\n      };\n    }\n    return undefined;\n  }\n\n  private limitClause(): LimitClause | undefined {\n    if (isToken.LIMIT(this.look()) && this.look(2).value === ',') {\n      return {\n        type: NodeType.limit_clause,\n        limitToken: this.next(),\n        offsetToken: this.next(),\n        countToken: this.next() && this.next(), // Discard comma token\n      };\n    }\n    if (isToken.LIMIT(this.look())) {\n      return {\n        type: NodeType.limit_clause,\n        limitToken: this.next(),\n        countToken: this.next(),\n      };\n    }\n    return undefined;\n  }\n\n  private allColumnsAsterisk(): AllColumnsAsterisk | undefined {\n    if (this.look().value === '*' && isToken.SELECT(this.look(-1))) {\n      this.next();\n      return { type: NodeType.all_columns_asterisk };\n    }\n    return undefined;\n  }\n\n  // Returns current token without advancing the pointer\n  private look(ahead = 0): Token {\n    return this.tokens[this.index + ahead] || EOF_TOKEN;\n  }\n\n  // Returns current token and advances the pointer to next token\n  private next(): Token {\n    return this.tokens[this.index++] || EOF_TOKEN;\n  }\n\n  private nextTokenNode(): TokenNode {\n    return { type: NodeType.token, token: this.next() };\n  }\n}\n"],"mappings":"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"}